<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Portal de Imigração - Status do Cliente</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
		<style>
			@keyframes fadeIn {
				from {
					opacity: 0;
					transform: translateY(10px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}
			.fade-in {
				animation: fadeIn 0.3s ease-out;
			}
		</style>
	</head>
	<body class="bg-gray-50">
		<!-- Login Screen -->
		<div
			id="loginScreen"
			class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
			<div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 fade-in">
				<div class="text-center mb-8">
					<div
						class="inline-flex items-center justify-center w-16 h-16 bg-indigo-600 rounded-full mb-4">
						<svg
							class="w-8 h-8 text-white"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24">
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
						</svg>
					</div>
					<h1 class="text-3xl font-bold text-gray-800 mb-2">
						Portal de Imigração
					</h1>
					<p class="text-gray-600">
						Acesse sua conta para ver o status do seu processo!
					</p>
				</div>

				<div class="space-y-6">
					<div>
						<label class="block text-sm font-medium text-gray-700 mb-2"
							>Email</label
						>
						<input
							type="email"
							id="email"
							class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
							placeholder="Digite seu email" />
					</div>

					<div>
						<label class="block text-sm font-medium text-gray-700 mb-2"
							>Senha</label
						>
						<input
							type="password"
							id="password"
							class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
							placeholder="Digite sua senha" />
					</div>

					<div
						id="errorMessage"
						class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-center gap-2">
						<svg
							class="w-5 h-5"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24">
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
						</svg>
						<span id="errorText"></span>
					</div>

					<button
						onclick="handleLogin()"
						id="loginBtn"
						class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
						Entrar
					</button>
				</div>

				<div class="mt-6 p-4 bg-gray-50 rounded-lg">
					<p class="text-sm text-gray-600 font-semibold mb-2">
						Configure seu Supabase:
					</p>
					<p class="text-xs text-gray-500">
						Adicione suas credenciais no código JavaScript
					</p>
				</div>
			</div>
		</div>

		<!-- Dashboard Screen -->
		<div id="dashboardScreen" class="hidden min-h-screen">
			<!-- Header -->
			<header class="bg-white shadow-sm border-b border-gray-200">
				<div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
					<div class="flex justify-between items-center">
						<div class="flex items-center gap-4">
							<div
								class="w-12 h-12 bg-indigo-600 rounded-lg flex items-center justify-center">
								<svg
									class="w-6 h-6 text-white"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24">
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
								</svg>
							</div>
							<div>
								<h1
									class="text-2xl font-bold text-gray-900"
									id="clientName"></h1>
								<p class="text-sm text-gray-500" id="processType"></p>
							</div>
						</div>
						<button
							onclick="handleLogout()"
							class="flex items-center gap-2 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
							<svg
								class="w-5 h-5"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24">
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
							</svg>
							Sair
						</button>
					</div>
				</div>
			</header>

			<div class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
				<!-- Status Card -->
				<div class="bg-white rounded-xl shadow-lg p-6 mb-8 fade-in">
					<div class="flex items-center justify-between mb-6">
						<div>
							<h2 class="text-2xl font-bold text-gray-900 mb-2">
								Status do Processo
							</h2>
							<p class="text-gray-600" id="currentStage"></p>
						</div>
						<div
							id="statusBadge"
							class="px-4 py-2 rounded-full font-semibold"></div>
					</div>

					<!-- Progress Bar -->
					<div class="mb-6">
						<div class="flex justify-between text-sm text-gray-600 mb-2">
							<span>Progresso</span>
							<span id="progressPercent"></span>
						</div>
						<div class="w-full bg-gray-200 rounded-full h-3">
							<div
								id="progressBar"
								class="h-3 rounded-full transition-all duration-500"></div>
						</div>
					</div>

					<!-- Dates -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div class="flex items-center gap-3">
							<svg
								class="w-5 h-5 text-gray-400"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24">
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
							</svg>
							<div>
								<p class="text-sm text-gray-500">Data de Início</p>
								<p class="font-semibold text-gray-900" id="startDate"></p>
							</div>
						</div>
						<div class="flex items-center gap-3">
							<svg
								class="w-5 h-5 text-gray-400"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24">
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
							</svg>
							<div>
								<p class="text-sm text-gray-500">Previsão de Conclusão</p>
								<p class="font-semibold text-gray-900" id="endDate"></p>
							</div>
						</div>
					</div>
				</div>

				<!-- Tabs -->
				<div class="bg-white rounded-xl shadow-lg overflow-hidden fade-in">
					<div class="border-b border-gray-200">
						<div class="flex">
							<button
								onclick="switchTab('overview')"
								id="tabOverview"
								class="px-6 py-4 font-semibold transition-colors text-indigo-600 border-b-2 border-indigo-600">
								Visão Geral
							</button>
							<button
								onclick="switchTab('documents')"
								id="tabDocuments"
								class="px-6 py-4 font-semibold transition-colors text-gray-500 hover:text-gray-700">
								Documentos
							</button>
							<button
								onclick="switchTab('history')"
								id="tabHistory"
								class="px-6 py-4 font-semibold transition-colors text-gray-500 hover:text-gray-700">
								Histórico
							</button>
						</div>
					</div>

					<div class="p-6">
						<!-- Overview Tab -->
						<div id="overviewContent" class="space-y-6">
							<div class="bg-gray-50 rounded-lg p-4">
								<h3 class="font-semibold text-gray-900 mb-4">
									Informações de Contato
								</h3>
								<div class="space-y-3">
									<div class="flex items-center gap-3">
										<svg
											class="w-5 h-5 text-gray-400"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24">
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
										</svg>
										<span class="text-gray-700" id="clientEmail"></span>
									</div>
									<div class="flex items-center gap-3">
										<svg
											class="w-5 h-5 text-gray-400"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24">
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
										</svg>
										<span class="text-gray-700" id="clientPhone"></span>
									</div>
									<div class="flex items-center gap-3">
										<svg
											class="w-5 h-5 text-gray-400"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24">
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
										</svg>
										<span class="text-gray-700" id="clientAddress"></span>
									</div>
								</div>
							</div>

							<div>
								<h3 class="font-semibold text-gray-900 mb-4">
									Próximos Passos
								</h3>
								<div id="nextSteps" class="space-y-3"></div>
							</div>
						</div>

						<!-- Documents Tab -->
						<div id="documentsContent" class="hidden space-y-3"></div>

						<!-- History Tab -->
						<div id="historyContent" class="hidden space-y-4"></div>
					</div>
				</div>
			</div>
		</div>

		<script>
			// ========================================
			// SUPABASE CONFIGURATION
			// ========================================
			// Replace these with your actual Supabase credentials
			const SUPABASE_URL = "https://lqyvatogkwndlpsetwie.supabase.co";
			const SUPABASE_ANON_KEY =
				"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxeXZhdG9na3duZGxwc2V0d2llIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MTkwODAsImV4cCI6MjA3NzQ5NTA4MH0.-OOYSpIt9YcLiMt2RTlfY7KUQWHMnELf1OczPpb-2II";

			// Initialize Supabase client
			const supabase = window.supabase.createClient(
				SUPABASE_URL,
				SUPABASE_ANON_KEY
			);

			let currentClient = null;
			let currentUser = null;

			// ========================================
			// AUTHENTICATION FUNCTIONS
			// ========================================
			async function handleLogin() {
				const email = document.getElementById("email").value;
				const password = document.getElementById("password").value;
				const errorMessage = document.getElementById("errorMessage");
				const errorText = document.getElementById("errorText");
				const loginBtn = document.getElementById("loginBtn");

				if (!email || !password) {
					errorText.textContent = "Por favor, preencha todos os campos";
					errorMessage.classList.remove("hidden");
					return;
				}

				loginBtn.disabled = true;
				loginBtn.textContent = "Entrando...";

				try {
					// Sign in with Supabase Auth
					const { data: authData, error: authError } =
						await supabase.auth.signInWithPassword({
							email: email,
							password: password,
						});

					if (authError) {
						throw authError;
					}

					currentUser = authData.user;

					// Fetch client data
					const { data: clientData, error: clientError } = await supabase
						.from("clientes")
						.select("*")
						.eq("user_id", currentUser.id)
						.single();

					if (clientError) {
						throw new Error("Dados do cliente não encontrados");
					}

					currentClient = clientData;
					errorMessage.classList.add("hidden");
					await showDashboard();
				} catch (error) {
					console.error("Login error:", error);
					errorText.textContent = error.message || "Erro ao fazer login";
					errorMessage.classList.remove("hidden");
				} finally {
					loginBtn.disabled = false;
					loginBtn.textContent = "Entrar";
				}
			}

			async function handleLogout() {
				await supabase.auth.signOut();
				currentClient = null;
				currentUser = null;
				document.getElementById("email").value = "";
				document.getElementById("password").value = "";
				document.getElementById("loginScreen").classList.remove("hidden");
				document.getElementById("dashboardScreen").classList.add("hidden");
			}

			// ========================================
			// DASHBOARD FUNCTIONS
			// ========================================
			async function showDashboard() {
				document.getElementById("loginScreen").classList.add("hidden");
				document.getElementById("dashboardScreen").classList.remove("hidden");

				// Update header
				document.getElementById(
					"clientName"
				).textContent = `Bem-vindo, ${currentClient.nome}`;
				document.getElementById("processType").textContent =
					currentClient.processo;

				// Update status card
				document.getElementById("currentStage").textContent =
					currentClient.etapa;
				document.getElementById(
					"progressPercent"
				).textContent = `${currentClient.progresso}%`;
				document.getElementById("startDate").textContent = formatDate(
					currentClient.data_inicio
				);
				document.getElementById("endDate").textContent = formatDate(
					currentClient.previsao_conclusao
				);

				const statusBadge = document.getElementById("statusBadge");
				const progressBar = document.getElementById("progressBar");

				let statusText = "";
				let statusColor = "";
				let progressColor = "";

				if (currentClient.status === "concluido") {
					statusText = "Concluído";
					statusColor = "bg-green-500 text-white";
					progressColor = "bg-green-500";
				} else if (currentClient.status === "em_progresso") {
					statusText = "Em Progresso";
					statusColor = "bg-blue-500 text-white";
					progressColor = "bg-blue-500";
				} else {
					statusText = "Pendente";
					statusColor = "bg-yellow-500 text-white";
					progressColor = "bg-yellow-500";
				}

				statusBadge.textContent = statusText;
				statusBadge.className = `px-4 py-2 rounded-full font-semibold ${statusColor}`;
				progressBar.className = `h-3 rounded-full transition-all duration-500 ${progressColor}`;
				progressBar.style.width = `${currentClient.progresso}%`;

				// Update contact info
				document.getElementById("clientEmail").textContent =
					currentClient.email;
				document.getElementById("clientPhone").textContent =
					currentClient.telefone;
				document.getElementById("clientAddress").textContent =
					currentClient.telefone;

				// Load related data
				await loadNextSteps();
				await loadDocuments();
				await loadHistory();
			}

			async function loadNextSteps() {
				try {
					const { data, error } = await supabase
						.from("proximos_passos")
						.select("*")
						.eq("cliente_id", currentClient.id)
						.order("ordem", { ascending: true });

					if (error) throw error;

					const nextSteps = document.getElementById("nextSteps");
					nextSteps.innerHTML = "";

					if (data && data.length > 0) {
						data.forEach((passo, index) => {
							nextSteps.innerHTML += `
                            <div class="flex items-start gap-3 p-3 bg-blue-50 rounded-lg">
                                <div class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">
                                    ${index + 1}
                                </div>
                                <p class="text-gray-700">${passo.descricao}</p>
                            </div>
                        `;
						});
					} else {
						nextSteps.innerHTML =
							'<p class="text-gray-500">Nenhum próximo passo pendente.</p>';
					}
				} catch (error) {
					console.error("Error loading next steps:", error);
				}
			}

			async function loadDocuments() {
				try {
					const { data, error } = await supabase
						.from("documentos")
						.select("*")
						.eq("cliente_id", currentClient.id)
						.order("nome", { ascending: true });

					if (error) throw error;

					const documentsContent = document.getElementById("documentsContent");
					documentsContent.innerHTML = "";

					if (data && data.length > 0) {
						data.forEach((doc) => {
							const statusInfo = getDocStatusInfo(doc.status);
							documentsContent.innerHTML += `
                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-indigo-300 transition-colors">
                                <div class="flex items-center gap-3">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <span class="font-medium text-gray-900">${doc.nome}</span>
                                </div>
                                <div class="flex items-center gap-2 px-3 py-1 rounded-full ${statusInfo.color}">
                                    ${statusInfo.icon}
                                    <span class="text-sm font-semibold capitalize">${statusInfo.text}</span>
                                </div>
                            </div>
                        `;
						});
					} else {
						documentsContent.innerHTML =
							'<p class="text-gray-500">Nenhum documento cadastrado.</p>';
					}
				} catch (error) {
					console.error("Error loading documents:", error);
				}
			}

			async function loadHistory() {
				try {
					const { data, error } = await supabase
						.from("historico")
						.select("*")
						.eq("cliente_id", currentClient.id)
						.order("data", { ascending: false });

					if (error) throw error;

					const historyContent = document.getElementById("historyContent");
					historyContent.innerHTML = "";

					if (data && data.length > 0) {
						data.forEach((item, index) => {
							const isLast = index === data.length - 1;
							historyContent.innerHTML += `
                            <div class="flex gap-4">
                                <div class="flex flex-col items-center">
                                    <div class="w-3 h-3 bg-indigo-600 rounded-full"></div>
                                    ${
																			!isLast
																				? '<div class="w-0.5 flex-1 bg-gray-300 my-1"></div>'
																				: ""
																		}
                                </div>
                                <div class="pb-6">
                                    <p class="text-sm text-gray-500 mb-1">${formatDate(
																			item.data
																		)}</p>
                                    <p class="text-gray-900 font-medium">${
																			item.evento
																		}</p>
                                </div>
                            </div>
                        `;
						});
					} else {
						historyContent.innerHTML =
							'<p class="text-gray-500">Nenhum histórico disponível.</p>';
					}
				} catch (error) {
					console.error("Error loading history:", error);
				}
			}

			// ========================================
			// HELPER FUNCTIONS
			// ========================================
			function getDocStatusInfo(status) {
				const icons = {
					aprovado: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>`,
					em_analise: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>`,
					pendente: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>`,
				};

				const colors = {
					aprovado: "text-green-600 bg-green-50",
					em_analise: "text-blue-600 bg-blue-50",
					pendente: "text-yellow-600 bg-yellow-50",
				};

				const texts = {
					aprovado: "Aprovado",
					em_analise: "Em Análise",
					pendente: "Pendente",
				};

				return {
					icon: icons[status] || icons.pendente,
					color: colors[status] || colors.pendente,
					text: texts[status] || "Desconhecido",
				};
			}

			function formatDate(dateString) {
				if (!dateString) return "N/A";
				const date = new Date(dateString);
				return date.toLocaleDateString("pt-BR");
			}

			function switchTab(tab) {
				const tabs = ["overview", "documents", "history"];
				tabs.forEach((t) => {
					const btn = document.getElementById(
						`tab${t.charAt(0).toUpperCase() + t.slice(1)}`
					);
					const content = document.getElementById(`${t}Content`);

					if (t === tab) {
						btn.className =
							"px-6 py-4 font-semibold transition-colors text-indigo-600 border-b-2 border-indigo-600";
						content.classList.remove("hidden");
					} else {
						btn.className =
							"px-6 py-4 font-semibold transition-colors text-gray-500 hover:text-gray-700";
						content.classList.add("hidden");
					}
				});
			}

			// ========================================
			// EVENT LISTENERS
			// ========================================
			document
				.getElementById("password")
				.addEventListener("keypress", function (e) {
					if (e.key === "Enter") {
						handleLogin();
					}
				});

			// Check for existing session on load
			supabase.auth.getSession().then(({ data: { session } }) => {
				if (session) {
					currentUser = session.user;
					supabase
						.from("clientes")
						.select("*")
						.eq("user_id", currentUser.id)
						.single()
						.then(({ data }) => {
							if (data) {
								currentClient = data;
								showDashboard();
							}
						});
				}
			});
		</script>
	</body>
</html>
